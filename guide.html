<!DOCTYPE html>
<html>

<head>
  <title>System Restoration Guide for Raspberry Pi</title>
</head>

<body>

  <h1>System Restoration Guide for Raspberry Pi</h1>

  <p>
    This guide will walk you through the process of restoring a Raspberry Pi system to run the server developed by Tarik.
    This server enables Skydive Mesquite to have their own local server and provide links for customers to download their
    jump media. The server is controlled by Nginx, files are read from a shared NFS folder, and most of the system is
    managed through a shell script called "zipandmove". Additionally, there is a backup routine that runs every two weeks,
    saving an image of the entire system on an external drive attached to the Raspberry Pi.
  </p>

  <h2>Setting up NFS Server for Other Machines</h2>

  <ol>
    <li>Install the necessary dependencies for NFS:</li>
  </ol>

  <pre><code>sudo apt install nfs-kernel-server</code></pre>

  <ol start="2">
    <li>Enable the NFS server to start on boot:</li>
  </ol>

  <pre><code>sudo systemctl enable --now nfs-server</code></pre>

  <ol start="3">
    <li>Create the directory to be shared with others:</li>
  </ol>

  <pre><code>mkdir -p /media/nfs</code></pre>

  <ol start="4">
    <li>Edit the NFS configuration file:</li>
  </ol>

  <pre><code>sudo nano /etc/exports</code></pre>

  <ol start="5">
    <li>Add the following line to the bottom of the file, ensuring that the network matches your current local network:</li>
  </ol>

  <pre><code>/media/nfs 192.168.1.0/24(rw,all_squash,insecure,async,no_subtree_check,anonuid=1000,anongid=1000)</code></pre>

  <ol start="6">
    <li>Export the new configuration:</li>
  </ol>

  <pre><code>sudo exportfs -arv</code></pre>

  <h2>Connecting to the NFS from Other Computers (not the Raspberry Pi)</h2>

  <ol>
    <li>Install the necessary dependencies for NFS:</li>
  </ol>

  <pre><code>sudo apt install nfs-common</code></pre>

  <ol start="2">
    <li>Mount the NFS share for the first time to test (replace XXX.XXX.XXX.XXX with the Raspberry Pi's local IP):</li>
  </ol>

  <pre><code>sudo mount -t nfs4 XXX.XXX.XXX.XXX:/media/nfs /media/share</code></pre>

  <ol start="3">
    <li>If you can access the shared directory now, make the mount automatic:</li>
  </ol>

  <pre><code>sudo nano /etc/fstab</code></pre>

  <ol start="4">
    <li>Add the following line to the bottom of the file, replacing XXX.XXX.XXX.XXX with the Raspberry Pi's local IP:</li>
  </ol>

  <pre><code>XXX.XXX.XXX.XXX:/media/nfs /media/share nfs4 defaults,user,exec 0 0</code></pre>

  <ol start="5">
    <li>Commit the configuration:</li>
  </ol>

  <pre><code>sudo mount -a</code></pre>

  <h2>Setting up the Web Server with Nginx</h2>

  <ol>
    <li>Install Nginx:</li>
  </ol>

  <pre><code>sudo apt install nginx</code></pre>

  <ol start="2">
    <li>Create a configuration file for skydivingstuff.com:</li>
  </ol>

  <pre><code>sudo nano /etc/nginx/conf.d/www.skydivingstuff.com</code></pre>

  <ol start="3">
    <li>Paste the following configuration into the file:</li>
  </ol>

  <pre><code>server {
    server_name skydivingstuff.com www.skydivingstuff.com;

    location /media {
        alias /home/monolith/Web/;
    }

    location / {
        return 301 https://skydivemesquite.com;
    }
}</code></pre>

  <ol start="4">
    <li>Follow the instructions in this <a href="https://www.nginx.com/blog/using-free-ssltls-certificates-from-lets-encrypt-with-nginx/">guide</a> to obtain and configure a free SSL/TLS certificate from Let's Encrypt with Nginx:</li>
  </ol>

  <pre><code>sudo apt update
sudo apt install certbot
sudo apt install python3-certbot-nginx
sudo nginx -t &amp;&amp; nginx -s reload
sudo certbot --nginx -d skydivingstuff.com -d www.skydivingstuff.com</code></pre>

  <ol start="5">
    <li>Automate the certificate renewal process:</li>
  </ol>

  <pre><code>sudo crontab -e</code></pre>

  <pre><code>0 12 * * * /usr/bin/certbot renew --quiet</code></pre>

  <h2>Moving Required Scripts</h2>

  <ol>
    <li>Move the "zipandmove" script to either <code>/usr/bin/</code> or <code>/usr/local/bin</code>:</li>
  </ol>

  <pre><code>sudo cp ~/Documents/zipandmove /usr/bin</code></pre>

  <ol start="2">
    <li>Copy the "rpi_back" script to either <code>/usr/bin/</code> or <code>/usr/local/bin</code>:</li>
  </ol>

  <pre><code>sudo cp ~/Documents/rpi_back /usr/bin</code></pre>

  <ol start="3">
    <li>Automate the "rpi_back" script:</li>
  </ol>

  <pre><code>sudo crontab -e</code></pre>

  <pre><code>0 1 * * 1/2 /usr/local/bin/rpi_back</code></pre>

</body>

</html>
